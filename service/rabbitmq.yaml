service:
  name: rabbitmq
  daemonset: true
  ports:
    - rabbitmq_port
  containers:
    - name: rabbitmq
      image: rabbitmq
      probes:
        readiness: "/opt/ccp/bin/rbmq-readiness.py"
        liveness: "true"
      volumes:
      - name: rabbitmq-logs
        path: "/var/log/ccp/rabbitmq"
        type: host
        readOnly: False
      pre:
        - name: chown-logs-dir
          command: "sudo /bin/chown rabbitmq: /var/log/ccp/rabbitmq"
      daemon:
        command: /start-rabbit
        files:
          - rabbitmq-conf
          - erlang-cookie
          - rabbitmq-env-conf
          - enabled-plugins
          - readiness
files:
  rabbitmq-conf:
    path: /etc/rabbitmq/rabbitmq.config
    content: rabbitmq.config.j2
  rabbitmq-env-conf:
    path: /etc/rabbitmq/rabbitmq-env.conf
    content: rabbitmq-env.conf.j2
  enabled-plugins:
    path: /etc/rabbitmq/enabled_plugins
    content: enabled_plugins.j2
  erlang-cookie:
    path: /var/lib/rabbitmq/.erlang.cookie
    content: erlang.cookie.j2
    perm: "400"
  readiness:
    path: /opt/ccp/bin/rbmq-readiness.py
    content: readiness.py.j2
    perm: "755"

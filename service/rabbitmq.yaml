dsl_version: 0.1.0
service:
  name: rabbitmq
  kind: DaemonSet
  ports:
    - {{ rabbitmq.port }}
  containers:
    - name: rabbitmq
      image: rabbitmq
      probes:
        readiness: "/opt/ccp/bin/rabbitmq-readiness.sh"
        liveness:
          command: "/opt/ccp/bin/rabbitmq-liveness.sh"
          type: "exec"
      volumes:
        - name: rabbitmq-logs
          path: "/var/log/ccp/rabbitmq"
          type: host
          readOnly: False
      pre:
        - name: chown-logs-dir
          command: "sudo /bin/chown rabbitmq: /var/log/ccp/rabbitmq"
    #  {% if security.tls.enabled %}
      env:
        - name: RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS
          value: "-pa /usr/lib/erlang/lib/ssl-8.0.3/ebin -proto_dist inet_tls -ssl_dist_opt server_certfile /etc/ccp/rabbitmq.pem -ssl_dist_opt server_secure_renegotiate true client_secure_renegotiate true server_cacertfile /etc/ccp/ca.pem"
        - name: RABBITMQ_CTL_ERL_ARGS
          value: "-pa /usr/lib/erlang/lib/ssl-8.0.3/ebin -proto_dist inet_tls -ssl_dist_opt server_certfile /etc/ccp/rabbitmq.pem -ssl_dist_opt server_secure_renegotiate true client_secure_renegotiate true server_cacertfile /etc/ccp/ca.pem"
    # {% endif %}
      daemon:
        dependencies:
          - etcd
        command: /usr/lib/rabbitmq/bin/rabbitmq-server
        files:
          - rabbitmq-conf
          - erlang-cookie
          - rabbitmq-env-conf
          - enabled-plugins
          - rabbitmq-readiness
          - rabbitmq-liveness
          - rabbitmq-check-helpers
        #  {% if security.tls.enabled %}
          - server_certificate
          - server_key
          - ca_certificate
          - combined
        # {% endif %}
      post:
        - name: create-startup-marker
          command: "date +%s > /tmp/rabbit-startup-marker"
files:
  rabbitmq-conf:
    path: /etc/rabbitmq/rabbitmq.config
    content: rabbitmq.config.j2
  rabbitmq-env-conf:
    path: /etc/rabbitmq/rabbitmq-env.conf
    content: rabbitmq-env.conf.j2
  enabled-plugins:
    path: /etc/rabbitmq/enabled_plugins
    content: enabled_plugins.j2
  erlang-cookie:
    path: /var/lib/rabbitmq/.erlang.cookie
    content: erlang.cookie.j2
    perm: "400"
  rabbitmq-readiness:
    path: /opt/ccp/bin/rabbitmq-readiness.sh
    content: rabbitmq-readiness.sh.j2
    perm: "755"
  rabbitmq-liveness:
    path: /opt/ccp/bin/rabbitmq-liveness.sh
    content: rabbitmq-liveness.sh.j2
    perm: "755"
  rabbitmq-check-helpers:
    path: /opt/ccp/bin/rabbitmq-check-helpers.sh
    content: rabbitmq-check-helpers.sh.j2
    perm: "644"
# {% if security.tls.enabled %}
  server_certificate:
    path: /etc/ccp/rabbitmq_certificate.pem
    content: server.pem.j2
  server_key:
    path: /etc/ccp/rabbitmq_server_key.pem
    content: server-key.pem.j2
  ca_certificate:
    path: /etc/ccp/ca.pem
    content: ca.pem.j2
  combined:
    path: /etc/ccp/rabbitmq.pem
    content: rabbitmq_combined.pem.j2
# {% endif %}
